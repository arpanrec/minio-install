- name: Minio | KES/Server | Create Docker Network
  community.docker.docker_network:
      name: miniokes
      state: present

- name: Minio | KES | Create Docker Container
  community.docker.docker_container:
      name: "{{ minio_kes_container_name }}"
      image: quay.io/minio/kes
      pull: missing
      state: started
      recreate: true
      restart: true
      detach: true
      restart_policy: unless-stopped
      capabilities:
          - CAP_IPC_LOCK
      ports:
          - "{{ minio_kes_port }}:{{ minio_kes_port }}"
      hostname: "{{ minio_kes_container_name }}"
      user: "{{ minio_kes_tmp_user_creation.uid }}:{{ minio_kes_tmp_group_creation.gid }}"
      volumes:
          - "{{ minio_kes_home }}:{{ minio_kes_home }}"
      networks:
          - name: miniokes
      command: "server --config={{ minio_kes_config_file }}"

- name: Minio | Server | Create Docker Container
  community.docker.docker_container:
      name: "{{ minio_server_container_name }}"
      image: quay.io/minio/minio
      pull: missing
      state: started
      recreate: true
      restart: true
      detach: true
      restart_policy: unless-stopped
      hostname: "{{ minio_server_container_name }}"
      user: "{{ minio_server_tmp_user_creation.uid }}:{{ minio_server_tmp_group_creation.gid }}"
      volumes:
          - "{{ minio_server_home }}:{{ minio_server_home }}"
      networks:
          - name: miniokes
      ports:
          - "{{ minio_server_port }}:{{ minio_server_port }}"
          - "{{ minio_server_console_port }}:{{ minio_server_console_port }}"
      env:
          MINIO_KMS_KES_ENDPOINT: "https://{{ minio_kes_container_name }}:{{ minio_kes_port }}"
          MINIO_KMS_KES_KEY_FILE: "{{ minio_server_kes_client_key }}"
          MINIO_KMS_KES_CERT_FILE: "{{ minio_server_kes_client_cert }}"
          MINIO_KMS_KES_CAPATH: "{{ minio_server_kes_client_ca }}"
          MINIO_KMS_KES_KEY_NAME: default
          MINIO_ROOT_USER: "{{ minio_server_root_user }}"
          MINIO_ROOT_PASSWORD: "{{ minio_server_root_password }}"
          MINIO_REGION: us-east-1
      command: "server {{ minio_server_data_dir }} --address :{{ minio_server_port }} --console-address \
          :{{ minio_server_console_port }} --certs-dir {{ minio_server_certs_dir }}"
